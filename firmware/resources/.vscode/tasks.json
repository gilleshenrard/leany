{
    "version": "2.0.0",
    "tasks": [
        {
            "type": "shell",
            "label": "Flash with OpenOCD",
            "command": "openocd",
            "windows": {
                "args": [
                    "-f", "interface/stlink.cfg",
                    "-f", "target/stm32f1x.cfg",
                    "-c", "adapter speed 4000",
                    "-c", "program {${command:cmake.getLaunchTargetPath}} verify reset exit"
                ]
            },
            "linux": {
                "args": [
                    "-f", "interface/stlink.cfg",
                    "-f", "target/stm32f1x.cfg",
                    "-c", "adapter speed 4000",
                    "-c", "program ${command:cmake.getLaunchTargetPath} verify reset exit"
                ]
            },
            "dependsOn": ["CMake: build"],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Display symbols size",
            "command": "arm-none-eabi-nm",
            "args": [
                "--demangle=gnu-v3",
                "--print-size",
                "--size-sort",
                "--reverse-sort",
                "--format=sysv",
                "--radix=d",
                "--line-numbers",
                "Leany.elf"
            ],
            "options": {
                "cwd": "${command:cmake.buildDirectory}"
            },
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Backup compile_commands.json",
            "hide": true,
            "command": "cp",
            "windows": {
                "args": [
                    "${command:cmake.buildDirectory}\\compile_commands.json",
                    "${command:cmake.buildDirectory}\\compile_commands.json.backup"
                ]
            },
            "linux": {
                "args": [
                    "${command:cmake.buildDirectory}/compile_commands.json",
                    "${command:cmake.buildDirectory}/compile_commands.json.backup"
                ]
            },
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },
        {
            "type": "shell",
            "label": "Remove -fanalyzer from compile_commands.json",
            "hide": true,
            "windows": {
                "command": "powershell.exe",
                "args": [
                    "-Command",
                    "(Get-Content '${command:cmake.buildDirectory}\\compile_commands.json') -replace ''-fanalyzer'','''' | Set-Content '${command:cmake.buildDirectory}\\compile_commands.json'"
                ]
            },
            "linux": {
                "command": "sed",
                "args": [
                    "-i",
                    "s/-fanalyzer//g",
                    "${command:cmake.buildDirectory}/compile_commands.json"
                ]
            },
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },
        {
            "type": "shell",
            "label": "Run clang-tidy with custom compile_commands.json",
            "hide": true,
            "windows": {
                "command": "python.exe",
                "args": [
                    "C:/msys64/ucrt64/bin/run-clang-tidy",
                    "-quiet",
                    "-p${command:cmake.buildDirectory}",
                    "-extra-arg=--sysroot=C:/msys64/ucrt64/arm-none-eabi",
                    ".*(hardware^|ui^|tasks^|utils)\\\\.*\\.(c^|h^|inc)$"
                ],
                "options": {
                    "shell": {
                        "executable": "cmd.exe",
                        "args": ["/d", "/c"]
                    }
                }
            },
            "linux": {
                "command": "run-clang-tidy",
                "args": [
                    "-quiet",
                    "-p${command:cmake.buildDirectory}",
                    "-extra-arg=--sysroot=/opt/arm-none-eabi/arm-none-eabi/",
                    "\".*(hardware|ui|tasks|utils)/.*\\.(c|h|inc)$\""
                ]
            },
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },
        {
            "type": "shell",
            "label": "Restore compile_commands.json",
            "hide": true,
            "windows": {
                "command": "move",
                "args": [
                    "/Y",
                    "${command:cmake.buildDirectory}\\compile_commands.json.backup",
                    "${command:cmake.buildDirectory}\\compile_commands.json"
                ],
                "options": {
                    "shell": {
                        "executable": "cmd.exe",
                        "args": ["/d", "/c"]
                    }
                }
            },
            "linux": {
                "command": "mv",
                "args": [
                    "${command:cmake.buildDirectory}/compile_commands.json.backup",
                    "${command:cmake.buildDirectory}/compile_commands.json"
                ]
            },
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },
        {
            "label": "Run clang-tidy",
            "dependsOrder": "sequence",
            "dependsOn": [
                "Backup compile_commands.json",
                "Remove -fanalyzer from compile_commands.json",
                "Run clang-tidy with custom compile_commands.json",
                "Restore compile_commands.json"
            ],
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Run clang-format validation",
            "windows": {
                "command": "Get-ChildItem -Path hardware,ui,tasks,utils -Recurse -Include *.c,*.h,*.inc -File | ForEach-Object {clang-format --style=file --dry-run --Werror --verbose $_.FullName }"
            },
            "linux": {
                "command": "find hardware ui tasks utils -name '*.c' -o -name '*.h'-o -name '*.inc' | xargs clang-format --style=file --dry-run --Werror --verbose"
            },
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Run Doxygen",
            "command": "doxygen",
            "args": [
                "firmware/Doxyfile"
            ],
            "options": {
                "cwd": "${workspaceFolder}/.."
            },
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Create the CppCheck output directory",
            "hide": true,
            "command": "mkdir",
            "windows":{
                "args": [
                    "-Force",
                    "config-cppcheck-build-dir"
                ]
            },
            "linux":{
                "args": [
                    "-p",
                    "config-cppcheck-build-dir"
                ],
            },
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },
        {
            "type": "shell",
            "label": "Run CppCheck",
            "dependsOn": [
                "Create the CppCheck output directory"
            ],
            "command": "cppcheck",
            "args": [
                "--enable=all",
                "--language=c",
                "--inconclusive",
                "--inline-suppr",
                "--error-exitcode=2",
                "--project=${command:cmake.launchTargetDirectory}/compile_commands.json",
                "--cppcheck-build-dir=config-cppcheck-build-dir/",
                "--check-level=exhaustive",
                "-ibuild/",
                "-iDrivers/",
                "-iMiddlewares/",
                "-iCore/",
                "--suppress=missingIncludeSystem",
                "--suppress=missingInclude",
                "--suppress=unusedFunction",
                "--suppress=unknownMacro"
            ],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Validate copyright and licensing",
            "command": "reuse",
            "args": [
                "--include-submodules",
                "lint"
            ],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Check enums and strucs documentation",
            "command": "python",
            "args": [
                "resources/check_enum_struct_members_doc.py",
                ".",
                "-r Core,Drivers,Middlewares",
            ],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Run Lizard",
            "command": "lizard",
            "args": [
                "-Tlength=60",
                "-Tnloc=60",
                "-Tparameter_count=5",
                "-Tcyclomatic_complexity=10",
                "-Eduplicate",
                "-m",
                "hardware/",
                "ui/",
                "tasks/",
                "utils/"
            ],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Normalize all file endings (LF)",
            "command": "git",
            "args": [
                "add",
                "--renormalize",
                ".",
            ],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        },


        {
            "type": "shell",
            "label": "Check Doxygen tags",
            "command": "python",
            "args": [
                "resources/check_doxygen_tags.py",
                ".",
                "--exclude", "build",
                "--exclude", "Drivers",
                "--exclude", "Middlewares",
                "--exclude", "Core"
            ],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": []
        }
    ]
}
