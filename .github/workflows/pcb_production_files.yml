# SPDX-FileCopyrightText: 2025 Gilles Henrard <contact@gilleshenrard.com>
#
# SPDX-License-Identifier: MIT

name: PCB checks and production files
on: 
  push:
    paths:
      - 'pcb/**'
      - '!pcb/resources/**'
      - 'pcb/resources/generate_production_files.bat'
      - 'pcb/resources/generate_production_files.sh'
      - 'pcb/resources/print_violations.sh'
      - '.github/workflows/pcb_production_files.yml'
  pull_request:
    paths:
      - 'pcb/**'
      - '!pcb/resources/**'
      - 'pcb/resources/generate_production_files.bat'
      - 'pcb/resources/generate_production_files.sh'
      - 'pcb/resources/print_violations.sh'
      - '.github/workflows/pcb_production_files.yml'
  schedule:
    - cron: "0 3 1 * *"

env:
  SCH_PATH: ${{github.workspace}}/pcb
  PROD_PATH: ${{github.workspace}}/pcb/production_files
  GBR_PATH: ${{github.workspace}}/pcb/gerber
  REPO_PATH: ${{github.workspace}}
  SCH_FILE: leany.kicad_sch
  PCB_FILE: leany.kicad_pcb
  ERC_FILE: erc.json
  DRC_FILE: drc.json
  CPL_FILENAME: CPL-JLCPCB
  BOM_FILENAME: BOM-JLCPCB
  GBR_FILENAME: GERBER-JLCPCB

jobs:
    kicad_checks:
        name: Run KiCad checks
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
            with:
              lfs: true

          - name: Check pulled LFS files
            working-directory: ${{env.REPO_PATH}}
            run:  |
                  git lfs ls-files
          
          - name: Install KiCad and libraries
            run: |
                  sudo add-apt-repository --yes ppa:kicad/kicad-9.0-releases
                  sudo apt-get update
                  sudo apt-get install --no-install-recommends -y \
                    kicad \
                    kicad-symbols \
                    kicad-footprints

          - name: Install jq
            run: sudo apt-get install -y jq

          - name: Configure KiCad library tables  
            run: |
              mkdir -p ~/.config/kicad/9.0
              
              # Use KiCad's default library tables if they exist
              if [ -f /usr/share/kicad/template/fp-lib-table.for_pretty ]; then
                cp /usr/share/kicad/template/fp-lib-table.for_pretty ~/.config/kicad/9.0/fp-lib-table
              fi
              
              if [ -f /usr/share/kicad/template/sym-lib-table ]; then
                cp /usr/share/kicad/template/sym-lib-table ~/.config/kicad/9.0/sym-lib-table
              fi
              
              # Fallback: generate from installed libraries if defaults don't exist
              if [ ! -f ~/.config/kicad/9.0/fp-lib-table ]; then
                echo "(fp_lib_table" > ~/.config/kicad/9.0/fp-lib-table
                echo "  (version 7)" >> ~/.config/kicad/9.0/fp-lib-table
                for lib in /usr/share/kicad/footprints/*.pretty; do
                  libname=$(basename "$lib" .pretty)
                  echo "  (lib (name \"$libname\")(type \"KiCad\")(uri \"$lib\")(options \"\")(descr \"\"))" >> ~/.config/kicad/9.0/fp-lib-table
                done
                echo ")" >> ~/.config/kicad/9.0/fp-lib-table
              fi
              
              echo "Footprint libraries configured: $(grep -c '(lib' ~/.config/kicad/9.0/fp-lib-table || echo 0)"
          
          - name: Check KiCAD version
            run: kicad-cli --version

          - name: Run Electrical Rules Check (ERC)
            id: erc
            continue-on-error: true
            working-directory: ${{env.SCH_PATH}}
            run: |
                  kicad-cli sch erc \
                    --output ${{env.ERC_FILE}} \
                    --format json \
                    --severity-all \
                    --exit-code-violations \
                    ${{env.SCH_FILE}}

          - name: Summarize ERC report
            if: steps.erc.outcome == 'failure'
            working-directory: ${{env.SCH_PATH}}
            run: |
                  source resources/print_violations.sh

                  echo "========== ERC Violations =========="
                  erc_json=$(cat ${{ env.SCH_PATH }}/${{ env.ERC_FILE }})

                  sheet_count=$(echo "$erc_json" | jq '.sheets | length')
                  for sheet_index in $(seq 0 $((sheet_count - 1))); do
                    sheet_path=$(echo "$erc_json" | jq -r ".sheets[$sheet_index].path")
                    echo "Sheet: $sheet_path"
                    print_violation_section "$erc_json" ".sheets[$sheet_index].violations" ""
                  done
                  echo "==================================="

          - name: Upload ERC report if ERC failed
            uses: actions/upload-artifact@v4
            if: steps.erc.outcome == 'failure'
            with:
              name: ${{env.ERC_FILE}}
              path: ${{env.SCH_PATH}}/${{env.ERC_FILE}}

          - name: Run Design Rules Check (DRC)
            id: drc
            continue-on-error: true
            working-directory: ${{env.SCH_PATH}}
            run: |
                  kicad-cli pcb drc \
                    --output ${{env.DRC_FILE}} \
                    --format json \
                    --severity-all \
                    --all-track-errors \
                    --schematic-parity \
                    --exit-code-violations \
                    ${{env.PCB_FILE}}

          - name: Summarize DRC report
            if: steps.drc.outcome == 'failure'
            working-directory: ${{env.SCH_PATH}}
            run: |
                  source resources/print_violations.sh

                  echo "========== DRC Violations =========="
                  drc_json=$(cat ${{ env.SCH_PATH }}/${{ env.DRC_FILE }})

                  print_violation_section "$drc_json" ".unconnected_items" "Unconnected items"
                  print_violation_section "$drc_json" ".violations" "Violations"
                  print_violation_section "$drc_json" ".schematic_parity" "Parity issues"
                  echo "==================================="

          - name: Upload DRC report if DRC failed
            uses: actions/upload-artifact@v4
            if: steps.drc.outcome == 'failure'
            with:
              name: ${{env.DRC_FILE}}
              path: ${{env.SCH_PATH}}/${{env.DRC_FILE}}

          - name: Final linting result
            run: |
                  failed=0
        
                  if [ "${{ steps.erc.outcome }}" != "success" ]; then
                    echo "::error::ERC failed"
                    failed=1
                  fi
                  if [ "${{ steps.drc.outcome }}" != "success" ]; then
                    echo "::error::DRC failed"
                    failed=1
                  fi
                  
                  [ $failed -eq 1 ] && exit 1 || exit 0

          - name: Generate the JLCPCB production files
            working-directory: ${{env.SCH_PATH}}
            run: |
                  resources/generate_production_files.sh

          - name: List BOM components
            working-directory: ${{env.SCH_PATH}}
            run: |
                  chmod +x resources/list_bom.sh
                  resources/list_bom.sh ${{ env.PROD_PATH }}/BOM-JLCPCB.csv

          # Upload the production files as an artifact
          - name: Save the production files
            uses: actions/upload-artifact@v6
            with:
              name: production-files
              if-no-files-found: error
              path: |
                ${{ env.PROD_PATH }}/JCLPCB_gerber.zip
                ${{ env.PROD_PATH }}/BOM-JLCPCB.csv
                ${{ env.PROD_PATH }}/CPL-JLCPCB.csv
